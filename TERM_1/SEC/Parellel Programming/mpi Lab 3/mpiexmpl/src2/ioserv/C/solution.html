<TITLE>A Solution to A simple output server</TITLE>
<BODY BGCOLOR="FFFFFF">
<PRE>
#include &lt;stdio.h&gt;
#include "mpi.h"

int main( argc, argv )
int argc;
char **argv;
{
    int rank, size;
    MPI_Comm new_comm;

    <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Init.html#MPI_Init">MPI_Init</A>( &amp;argc, &amp;argv );
    <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Comm_rank.html#MPI_Comm_rank">MPI_Comm_rank</A>( MPI_COMM_WORLD, &amp;rank );
    <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Comm_split.html#MPI_Comm_split">MPI_Comm_split</A>( MPI_COMM_WORLD, rank == 0, 0, &amp;new_comm );
    if (rank == 0) 
	master_io( MPI_COMM_WORLD, new_comm );
    else
	slave_io( MPI_COMM_WORLD, new_comm );

    <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Finalize.html#MPI_Finalize">MPI_Finalize</A>( );
    return 0;
}

#define MSG_EXIT 1
#define MSG_PRINT_ORDERED 2
#define MSG_PRINT_UNORDERED 3

/* This is the master */
int master_io( master_comm, comm )
MPI_Comm comm;
{
    int        i,j, size, nslave, firstmsg;
    char       buf[256], buf2[256];
    MPI_Status status;

    <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Comm_size.html#MPI_Comm_size">MPI_Comm_size</A>( master_comm, &amp;size );
    nslave = size - 1;
    while (nslave &gt; 0) {
	<A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Recv.html#MPI_Recv">MPI_Recv</A>( buf, 256, MPI_CHAR, MPI_ANY_SOURCE, MPI_ANY_TAG, 
		  master_comm, &amp;status );
	switch (status.MPI_TAG) {
	case MSG_EXIT: nslave--; break;
	case MSG_PRINT_UNORDERED:
	    fputs( buf, stdout );
	    break;
	case MSG_PRINT_ORDERED:
	    /* This lets us get any of the ordered messages first, and then
	       start printing them.  There are other ways to do this
	       (see related exercises) */
	    firstmsg = status.MPI_SOURCE;
	    for (i=1; i&lt;size; i++) {
		if (i == firstmsg) 
		    fputs( buf, stdout );
		else {
		    <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Recv.html#MPI_Recv">MPI_Recv</A>( buf2, 256, MPI_CHAR, i, MSG_PRINT_ORDERED, 
			  master_comm, &amp;status );
		    fputs( buf2, stdout );
		}
	    }
	    break;
	}
    }
    return 0;
}

/* This is the slave */
int slave_io( master_comm, comm )
MPI_Comm comm;
{
    char buf[256];
    int  rank;
    
    <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Comm_rank.html#MPI_Comm_rank">MPI_Comm_rank</A>( comm, &amp;rank );
    sprintf( buf, "Hello from slave %d\n", rank );
    <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Send.html#MPI_Send">MPI_Send</A>( buf, strlen(buf) + 1, MPI_CHAR, 0, MSG_PRINT_ORDERED, 
	      master_comm );
    
    sprintf( buf, "Goodbye from slave %d\n", rank );
    <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Send.html#MPI_Send">MPI_Send</A>( buf, strlen(buf) + 1, MPI_CHAR, 0, MSG_PRINT_ORDERED, 
	      master_comm );

    sprintf( buf, "I'm exiting (%d)\n", rank );
    <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Send.html#MPI_Send">MPI_Send</A>( buf, strlen(buf) + 1, MPI_CHAR, 0, MSG_PRINT_UNORDERED, 
	      master_comm );

    <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Send.html#MPI_Send">MPI_Send</A>( buf, 0, MPI_CHAR, 0, MSG_EXIT, master_comm );
    return 0;
}
</PRE>
</BODY>
