<TITLE>A Solution to Determining the amount of MPI buffering</TITLE>
<BODY BGCOLOR="FFFFFF">
<PRE>
/* test program to find out how much buffering a system supplies */

#include "mpi.h"
#include &lt;stdio.h&gt;

int main(argc,argv)
int argc;
char *argv[];
{
    int  myid, numprocs;
    int  namelen;
    char processor_name[MPI_MAX_PROCESSOR_NAME];
    char *buf;
    int  bufsize, other, done, i;
    double t1, t2, tbase;
    MPI_Status status;

    <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Init.html#MPI_Init">MPI_Init</A>(&amp;argc,&amp;argv);
    <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Comm_size.html#MPI_Comm_size">MPI_Comm_size</A>(MPI_COMM_WORLD,&amp;numprocs);
    <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Comm_rank.html#MPI_Comm_rank">MPI_Comm_rank</A>(MPI_COMM_WORLD,&amp;myid);
    
    /* Output processor names in rank order */
    <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Get_processor_name.html#MPI_Get_processor_name">MPI_Get_processor_name</A>(processor_name,&amp;namelen);
    if (myid &gt; 0) 
	<A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Recv.html#MPI_Recv">MPI_Recv</A>( MPI_BOTTOM, 0, MPI_INT, myid - 1, 5, MPI_COMM_WORLD, 
		  &amp;status );
    fprintf(stderr,"Process %d on %s\n", myid, processor_name);
    fflush( stderr );
    if (myid + 1 &lt; numprocs)
	<A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Send.html#MPI_Send">MPI_Send</A>( MPI_BOTTOM, 0, MPI_INT, myid + 1, 5, MPI_COMM_WORLD );


    bufsize = 1024;
    other   = (myid + 1) % 2;
    done    = 0;

    while (!done &amp;&amp; bufsize &lt; 1024*1024*16) {
	if ((buf = (char *) malloc (bufsize)) == NULL) {
	    fprintf(stderr, "%d could not malloc %d bytes\n", myid, bufsize );
	    <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Abort.html#MPI_Abort">MPI_Abort</A>( MPI_COMM_WORLD, 1 );
	    exit(-1);
	}
	/* fprintf(stderr,"%d sending %d to %d\n", myid, bufsize, other ); */
	if ((myid % 2) == 0) {
	    <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Send.html#MPI_Send">MPI_Send</A>( MPI_BOTTOM, 0, MPI_INT, other, 1, MPI_COMM_WORLD );
	    <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Recv.html#MPI_Recv">MPI_Recv</A>( MPI_BOTTOM, 0, MPI_INT, other, 2, MPI_COMM_WORLD, 
		      &amp;status );
	    /* Compute a time to send when the receive is waiting */
	    t1 = <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Wtime.html#MPI_Wtime">MPI_Wtime</A>();
	    <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Send.html#MPI_Send">MPI_Send</A>( buf, bufsize, MPI_CHAR, other, 100, MPI_COMM_WORLD );
	    t2 = <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Wtime.html#MPI_Wtime">MPI_Wtime</A>();
	    tbase = t2 - t1;
	    <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Recv.html#MPI_Recv">MPI_Recv</A>( MPI_BOTTOM, 0, MPI_INT, other, 2, MPI_COMM_WORLD, 
		      &amp;status );
	    /* Compute a time when the receive is NOT waiting */
	    t1 = <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Wtime.html#MPI_Wtime">MPI_Wtime</A>();
	    <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Send.html#MPI_Send">MPI_Send</A>( buf, bufsize, MPI_CHAR, other, 100, MPI_COMM_WORLD );
	    t2 = <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Wtime.html#MPI_Wtime">MPI_Wtime</A>();
	    if (t2 - t1 &gt; 1.5 &amp;&amp; t2 - t1 &gt; 2.0 * tbase) {
		printf( "<A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Send.html#MPI_Send">MPI_Send</A> blocks with buffers of size %d\n", 
			bufsize );
		done = 1;
	    }
	}
	else {
	    <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Recv.html#MPI_Recv">MPI_Recv</A>( MPI_BOTTOM, 0, MPI_INT, other, 1, MPI_COMM_WORLD, 
		      &amp;status );
	    t1 = <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Wtime.html#MPI_Wtime">MPI_Wtime</A>();
	    <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Send.html#MPI_Send">MPI_Send</A>( MPI_BOTTOM, 0, MPI_INT, other, 2, MPI_COMM_WORLD );
	    <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Recv.html#MPI_Recv">MPI_Recv</A>( buf, bufsize, MPI_CHAR, other, 100, MPI_COMM_WORLD, 
		      &amp;status );
	    <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Send.html#MPI_Send">MPI_Send</A>( MPI_BOTTOM, 0, MPI_INT, other, 2, MPI_COMM_WORLD );
	    while (<A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Wtime.html#MPI_Wtime">MPI_Wtime</A>() - t1 &lt; 2.0) ;
	    <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Recv.html#MPI_Recv">MPI_Recv</A>( buf, bufsize, MPI_CHAR, other, 100, MPI_COMM_WORLD, 
		      &amp;status );
	}
	fprintf(stderr,"%d received %d fr %d\n", myid, bufsize, other );
	free( buf );
	i = done;
	<A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Allreduce.html#MPI_Allreduce">MPI_Allreduce</A>( &amp;i, &amp;done, 1, MPI_INT, MPI_SUM, MPI_COMM_WORLD );
	bufsize *= 2;
    }
    <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Finalize.html#MPI_Finalize">MPI_Finalize</A>();
    return 0;
}

            
</PRE>
</BODY>
